Summary: An advanced package manager for KubeJS.
Name: kjspkg-cli
Version: git
Release: 1%{?dist}
Source0: %{name}-%{version}.tar.gz
License: MIT
Group: Development/Tools

%if "%{__debian}" != "1"
BuildRequires: bash
BuildRequires: git
BuildRequires: clang
BuildRequires: jq
BuildRequires: wget
BuildRequires: curl
BuildRequires: tar
BuildRequires: gzip
BuildRequires: rust
%endif

%description
An advanced package manager for KubeJS.

%prep
%setup -q

%define SOURCE "https://github.com/RedstoneWizard08/kjspkg"

%if "%{_arch}" == "armv7hl"
%define rust_target "arm-unknown-linux-gnueabihf"
%else
%define rust_target "%{_arch}-unknown-linux-gnu"
%endif

%install
export RUSTUP_HOME="%{buildroot}/rustup"
export CARGO_HOME="%{buildroot}/cargo"
export PATH="%{buildroot}/cargo/bin:$PATH"

curl -fsSL https://sh.rustup.rs | sh -s - -q -y --no-modify-path
curl -fsSL https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
cargo binstall cargo-zigbuild -y --force
curl -fsSL https://raw.githubusercontent.com/tristanisham/zvm/master/install.sh | bash
export PATH="$HOME/.zvm/self:$HOME/.zvm/bin:$PATH"
zvm install 0.13.0 --force
mkdir -p %{buildroot}/source
tar -C %{buildroot}/source -zxvf %{SOURCE0}
cd %{buildroot}/source/kjspkg-git
rustup target add %{rust_target}
cargo zigbuild --target %{rust_target} --release --bin kjspkg
mkdir -p %{buildroot}/%{_bindir}
cp %{buildroot}/source/kjspkg-git/target/%{rust_target}/release/kjspkg %{buildroot}/%{_bindir}
rm -rf %{buildroot}/source
rm -rf %{buildroot}/rustup
rm -rf %{buildroot}/cargo

%clean
rm -rf %{buildroot}

%files
%{_bindir}/kjspkg
