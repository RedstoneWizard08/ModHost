# Maintainer: RedstoneWizard08 <jacob1coder@gmail.com>
pkgname=kjspkg-cli
pkgver=git
pkgrel=1
epoch=
pkgdesc="An advanced package manager for KubeJS."
arch=(x86_64 i686 aarch64 armv7h)
url="https://github.com/RedstoneWizard08/kjspkg"
license=("MIT")
groups=()
depends=()
makedepends=(git clang jq wget curl tar bash gzip)
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
source=("git+$url")
noextract=()
md5sums=("SKIP")
validpgpkeys=()

pkgver() {
	cd "kjspkg"
	cargo_ver="$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "kjspkg").version')"
	git_ver="$(git rev-parse --short HEAD)"
	printf "%s.git+%s" "$cargo_ver" "$git_ver"
}

package() {
	export RUSTUP_HOME="${srcdir}/rustup"
	export CARGO_HOME="${srcdir}/cargo"
	export PATH="${srcdir}/cargo/bin:$PATH"

	curl -fsSL https://sh.rustup.rs | sh -s - -q -y --no-modify-path
	mkdir -p "${pkgdir}/usr/bin"
	curl -fsSL https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
	cargo binstall cargo-zigbuild -y --force
	curl -fsSL https://raw.githubusercontent.com/tristanisham/zvm/master/install.sh | bash
	export PATH="$HOME/.zvm/self:$HOME/.zvm/bin:$PATH"
	zvm install 0.13.0 --force

	BUILD_ARCH="${CARCH}"
	RUNTIME="gnu"

	if [[ "$BUILD_ARCH" = "armv7"* ]]; then
		BUILD_ARCH="arm"
		RUNTIME="gnueabihf"
	fi
	
	TARGET="$BUILD_ARCH-unknown-linux-$RUNTIME"
	cd "${srcdir}/kjspkg"
	rustup target add "$TARGET"
	cargo zigbuild --release --target "$TARGET" --bin kjspkg
	cp "${srcdir}/kjspkg/target/$TARGET/release/kjspkg" "${pkgdir}/usr/bin/kjspkg"
}
